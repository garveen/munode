# ShitSpeak é›†ç¾¤é€šä¿¡æ¶æ„è®¾è®¡æ–‡æ¡£

## æ–‡æ¡£ç‰ˆæœ¬
- **ç‰ˆæœ¬**: 2.0
- **æ—¥æœŸ**: 2025-11-18
- **çŠ¶æ€**: è®¾è®¡æ–¹æ¡ˆ

## æ¦‚è¿°

æœ¬æ–‡æ¡£å®šä¹‰ ShitSpeak é›†ç¾¤å†…é€šä¿¡æ¶æ„ï¼ŒåŒ…æ‹¬ Hub-Edge å’Œ Edge-Edge ä¹‹é—´çš„è¿æ¥ç®¡ç†ã€åè®®è®¾è®¡å’Œæ•…éšœå¤„ç†ç­–ç•¥ã€‚

### æ ¸å¿ƒå†³ç­–

- âœ… **ç§»é™¤ Protobuf + gRPC**ï¼šè¿‡åº¦å¤æ‚ï¼Œä¸é€‚åˆå†…éƒ¨é›†ç¾¤é€šä¿¡
- âœ… **æ§åˆ¶ä¿¡é“**ï¼šMessagePack + WebSocket + è‡ªå®šä¹‰ RPC
- âœ… **è¯­éŸ³ä¿¡é“**ï¼šè‡ªå®šä¹‰åè®®åŒ…ï¼Œé»˜è®¤ UDPï¼Œæ”¯æŒé™çº§åˆ° TCP
- âš ï¸ **Edge-å®¢æˆ·ç«¯è¿æ¥ä¸å˜**ï¼šæœ¬æ¬¡é‡æ„ä»…æ¶‰åŠé›†ç¾¤å†…é€šä¿¡
- ç‰¹åˆ«ç‰¹åˆ«æ³¨æ„ä¿ç•™Mumble.protoï¼Œè¿™ä¸ªæ˜¯edgeä¸å®¢æˆ·ç«¯çš„é€šä¿¡åè®®

### é€šä¿¡æ‹“æ‰‘

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Hub Server     â”‚
                    â”‚  (WS + UDP)      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚                 â”‚                 â”‚
      â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
      â”‚ Edge 1  â”‚â—„â”€â”€â”€â”€â”€â–ºâ”‚ Edge 2  â”‚â—„â”€â”€â”€â”€â”€â–ºâ”‚ Edge 3  â”‚
      â”‚WS + UDP â”‚       â”‚WS + UDP â”‚       â”‚WS + UDP â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                 â”‚                 â”‚
         Clients           Clients           Clients
        (ä¸å˜æ›´)           (ä¸å˜æ›´)           (ä¸å˜æ›´)
```

### ä¸¤ç§ä¿¡é“èŒè´£

| ä¿¡é“ | ä¼ è¾“å†…å®¹ | åè®® | å¯é æ€§è¦æ±‚ |
|------|---------|------|-----------|
| **æ§åˆ¶ä¿¡é“** | é™¤è¯­éŸ³å¤–çš„æ‰€æœ‰æ•°æ®ï¼šæ•°æ®åŒæ­¥ã€çŠ¶æ€æ›´æ–°ã€RPC è°ƒç”¨ã€å¿ƒè·³ | MessagePack over WebSocket | å¿…é¡»å¯é  |
| **è¯­éŸ³ä¿¡é“** | ä»…è¯­éŸ³æ•°æ®åŒ…ï¼Œä¾› voice-router ä½¿ç”¨ | è‡ªå®šä¹‰åè®® over UDP/TCP | å…è®¸ä¸¢åŒ… |

---

## ä¸€ã€æ§åˆ¶ä¿¡é“è®¾è®¡

### 1.1 æŠ€æœ¯é€‰å‹ï¼šMessagePack + WebSocket

**é€‰å‹ç†ç”±**
- âœ… **ç¼–ç ç®€å•**ï¼šä¸ JSON ä¸€æ ·æ˜“ç”¨ (`pack()` / `unpack()`)
- âœ… **é«˜æ•ˆä¼ è¾“**ï¼šæ¯” JSON èŠ‚çœ 30-40% å¸¦å®½
- âœ… **åŒå‘å®æ—¶**ï¼šWebSocket å…¨åŒå·¥ï¼Œä½å»¶è¿Ÿ
- âœ… **å¯é ä¼ è¾“**ï¼šåŸºäº TCPï¼Œä¿è¯æ¶ˆæ¯é¡ºåºå’Œåˆ°è¾¾
- âœ… **æ˜“äºè°ƒè¯•**ï¼šmsgpackr æä¾›è°ƒè¯•å·¥å…·

**vs Protobuf + gRPC**
| å¯¹æ¯”é¡¹ | MessagePack + WS | Protobuf + gRPC |
|--------|-----------------|----------------|
| ç¼–ç å¤æ‚åº¦ | â­ æç®€å• | â­â­â­â­ å¤æ‚ |
| è°ƒè¯•éš¾åº¦ | â­â­ ç®€å• | â­â­â­â­ å›°éš¾ |
| ä¼ è¾“æ•ˆç‡ | 80-90 bytes | 40-60 bytes |
| è¿æ¥å»ºç«‹ | < 10ms | 100-500ms (HTTP/2) |
| é€‚ç”¨åœºæ™¯ | å†…éƒ¨é›†ç¾¤ | è·¨è¯­è¨€å¾®æœåŠ¡ |

**ç»“è®º**ï¼šå¯¹äº Node.js å†…éƒ¨é›†ç¾¤ï¼ŒMessagePack + WS æ˜¯æœ€ä½³é€‰æ‹©ã€‚

### 1.2 è‡ªå®šä¹‰ RPC åè®®

**è®¾è®¡åŸåˆ™**
- ç®€å•ã€ç›´è§‚ã€æ˜“äºæ‰©å±•
- æ”¯æŒè¯·æ±‚-å“åº”å’Œå•å‘é€šçŸ¥
- å†…ç½®è¶…æ—¶å’Œé”™è¯¯å¤„ç†

**æ¶ˆæ¯æ ¼å¼**

```typescript
// åŸºç¡€æ¶ˆæ¯ç»“æ„
interface Message {
  id?: string;           // è¯·æ±‚IDï¼ˆå“åº”æ—¶å¿…å¡«ï¼Œé€šçŸ¥æ—¶å¯é€‰ï¼‰
  type: string;          // æ¶ˆæ¯ç±»å‹
  method?: string;       // RPC æ–¹æ³•åï¼ˆè¯·æ±‚æ—¶å¿…å¡«ï¼‰
  params?: any;          // å‚æ•°
  result?: any;          // ç»“æœï¼ˆå“åº”æ—¶ä½¿ç”¨ï¼‰
  error?: {              // é”™è¯¯ï¼ˆå“åº”æ—¶ä½¿ç”¨ï¼‰
    code: number;
    message: string;
    data?: any;
  };
  timestamp: number;     // æ—¶é—´æˆ³
}

// ç¤ºä¾‹ï¼šè¯·æ±‚
{
  id: "req-123",
  type: "request",
  method: "edge.register",
  params: {
    serverId: 1,
    name: "edge-1",
    host: "192.168.1.10",
    port: 64738
  },
  timestamp: 1700000000000
}

// ç¤ºä¾‹ï¼šå“åº”
{
  id: "req-123",
  type: "response",
  result: {
    success: true,
    peers: [
      { id: 2, host: "192.168.1.11", port: 64738 }
    ]
  },
  timestamp: 1700000000100
}

// ç¤ºä¾‹ï¼šé€šçŸ¥ï¼ˆæ— éœ€å“åº”ï¼‰
{
  type: "notification",
  method: "channel.updated",
  params: {
    channelId: 10,
    name: "New Channel"
  },
  timestamp: 1700000000200
}

// ç¤ºä¾‹ï¼šå¿ƒè·³
{
  type: "ping",
  timestamp: 1700000000300
}

// å¿ƒè·³å“åº”
{
  type: "pong",
  timestamp: 1700000000305
}
```

**å®ç°ç¤ºä¾‹**

```typescript
import WebSocket from 'ws';
import { pack, unpack } from 'msgpackr';
import { EventEmitter } from 'events';

export class RPCChannel extends EventEmitter {
  private ws: WebSocket;
  private pendingRequests = new Map<string, {
    resolve: (result: any) => void;
    reject: (error: Error) => void;
    timer: NodeJS.Timeout;
  }>();
  private requestTimeout = 30000; // 30ç§’
  
  constructor(ws: WebSocket) {
    super();
    this.ws = ws;
    this.ws.on('message', this.handleMessage.bind(this));
  }
  
  /**
   * å‘é€ RPC è¯·æ±‚
   */
  async call(method: string, params?: any, timeout?: number): Promise<any> {
    const id = this.generateId();
    const message: Message = {
      id,
      type: 'request',
      method,
      params,
      timestamp: Date.now(),
    };
    
    return new Promise((resolve, reject) => {
      // è®¾ç½®è¶…æ—¶
      const timer = setTimeout(() => {
        this.pendingRequests.delete(id);
        reject(new Error(`RPC timeout: ${method}`));
      }, timeout || this.requestTimeout);
      
      this.pendingRequests.set(id, { resolve, reject, timer });
      this.send(message);
    });
  }
  
  /**
   * å‘é€é€šçŸ¥ï¼ˆæ— éœ€å“åº”ï¼‰
   */
  notify(method: string, params?: any): void {
    const message: Message = {
      type: 'notification',
      method,
      params,
      timestamp: Date.now(),
    };
    this.send(message);
  }
  
  /**
   * å‘é€å“åº”
   */
  respond(id: string, result?: any, error?: any): void {
    const message: Message = {
      id,
      type: 'response',
      result,
      error,
      timestamp: Date.now(),
    };
    this.send(message);
  }
  
  /**
   * å¤„ç†æ¥æ”¶åˆ°çš„æ¶ˆæ¯
   */
  private handleMessage(data: Buffer): void {
    try {
      const message: Message = unpack(data);
      
      switch (message.type) {
        case 'request':
          this.handleRequest(message);
          break;
          
        case 'response':
          this.handleResponse(message);
          break;
          
        case 'notification':
          this.handleNotification(message);
          break;
          
        case 'ping':
          this.handlePing(message);
          break;
          
        case 'pong':
          this.handlePong(message);
          break;
      }
    } catch (error) {
      this.emit('error', error);
    }
  }
  
  private handleRequest(message: Message): void {
    this.emit('request', message, (result?: any, error?: any) => {
      this.respond(message.id!, result, error);
    });
  }
  
  private handleResponse(message: Message): void {
    const pending = this.pendingRequests.get(message.id!);
    if (pending) {
      clearTimeout(pending.timer);
      this.pendingRequests.delete(message.id!);
      
      if (message.error) {
        pending.reject(new Error(message.error.message));
      } else {
        pending.resolve(message.result);
      }
    }
  }
  
  private handleNotification(message: Message): void {
    this.emit('notification', message);
  }
  
  private handlePing(message: Message): void {
    this.send({ type: 'pong', timestamp: Date.now() });
    this.emit('ping', message.timestamp);
  }
  
  private handlePong(message: Message): void {
    const latency = Date.now() - message.timestamp;
    this.emit('pong', latency);
  }
  
  private send(message: Message): void {
    if (this.ws.readyState === WebSocket.OPEN) {
      this.ws.send(pack(message));
    } else {
      throw new Error('WebSocket not open');
    }
  }
  
  private generateId(): string {
    return `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
  }
}
```

### 1.3 æ§åˆ¶ä¿¡é“ç«¯å£é…ç½®

```yaml
hub:
  control_port: 8443      # Hub æ§åˆ¶ä¿¡é“ç›‘å¬ç«¯å£
  control_tls: true       # æ˜¯å¦å¯ç”¨ TLS

edge:
  control_port: 8543      # Edge æ§åˆ¶ä¿¡é“ç›‘å¬ç«¯å£ï¼ˆæ¥æ”¶å…¶ä»– Edge è¿æ¥ï¼‰
  control_tls: true
```

---

## äºŒã€è¯­éŸ³ä¿¡é“è®¾è®¡

### 2.1 æŠ€æœ¯é€‰å‹ï¼šè‡ªå®šä¹‰åè®® + UDPï¼ˆå¯é™çº§ TCPï¼‰

**é€‰å‹ç†ç”±**
- âœ… **æœ€å°å¼€é”€**ï¼šä»… 14 å­—èŠ‚å¤´éƒ¨
- âœ… **æœ€ä½å»¶è¿Ÿ**ï¼šUDP æ— è¿æ¥å»ºç«‹ï¼Œç›´æ¥å‘é€
- âœ… **å®ç°æç®€**ï¼š< 100 è¡Œä»£ç 
- âœ… **çµæ´»é™çº§**ï¼šUDP ä¸å¯ç”¨æ—¶è‡ªåŠ¨åˆ‡æ¢ TCP

**åŒ…ç»“æ„è®¾è®¡**

```
UDP/TCP è¯­éŸ³åŒ…æ ¼å¼:
+--------+----------+----------+----------+-------+-------------+
| Version| SenderID | TargetID | Sequence | Codec | Voice Data  |
| 1 byte | 4 bytes  | 4 bytes  | 4 bytes  | 1 byte| N bytes     |
+--------+----------+----------+----------+-------+-------------+
         |<------ 14 bytes header ------>|

å­—æ®µè¯´æ˜:
- Version (1 byte): åè®®ç‰ˆæœ¬ï¼Œå½“å‰ä¸º 0x01
- SenderID (4 bytes): å‘é€è€… Session ID (Big Endian)
- TargetID (4 bytes): ç›®æ ‡è·¯ç”± ID (Big Endian)
  - 0x00000000: å½“å‰é¢‘é“å¹¿æ’­
  - 0x00000001: æœåŠ¡å™¨å…¨å±€å¹¿æ’­
  - 0x00000002-0xFFFFFFFF: è‡ªå®šä¹‰è¯­éŸ³ç›®æ ‡ ID
- Sequence (4 bytes): åŒ…åºåˆ—å· (Big Endian)
- Codec (1 byte): ç¼–è§£ç å™¨ç±»å‹
  - 0x00: Opus
  - 0x01: CELT
  - å…¶ä»–: ä¿ç•™
- Voice Data: å®é™…è¯­éŸ³æ•°æ®
```

**UDP vs TCP é™çº§ç­–ç•¥**

```typescript
interface VoiceChannelConfig {
  preferredTransport: 'udp' | 'tcp';  // ä¼˜å…ˆä½¿ç”¨çš„ä¼ è¾“æ–¹å¼
  udpPort: number;                     // UDP ç«¯å£
  tcpPort: number;                     // TCP ç«¯å£ï¼ˆé™çº§ç”¨ï¼‰
  udpTimeout: number;                  // UDP è¿é€šæ€§æµ‹è¯•è¶…æ—¶ï¼ˆmsï¼‰
  autoFallback: boolean;               // æ˜¯å¦è‡ªåŠ¨é™çº§
}

// é™çº§é€»è¾‘
class VoiceChannel {
  private transport: 'udp' | 'tcp' = 'udp';
  
  async connect() {
    if (this.config.preferredTransport === 'udp') {
      const udpOk = await this.testUDP();
      if (udpOk) {
        this.transport = 'udp';
        return this.connectUDP();
      } else if (this.config.autoFallback) {
        console.warn('UDP unavailable, falling back to TCP');
        this.transport = 'tcp';
        return this.connectTCP();
      }
    } else {
      this.transport = 'tcp';
      return this.connectTCP();
    }
  }
  
  private async testUDP(): Promise<boolean> {
    // å‘é€æµ‹è¯•åŒ…ï¼Œç­‰å¾…å“åº”
    // å¦‚æœè¶…æ—¶ï¼Œè¿”å› false
  }
}
```

**æ€§èƒ½å¯¹æ¯”**

| ä¼ è¾“æ–¹å¼ | å»¶è¿Ÿ | ä¸¢åŒ…å¤„ç† | å¼€é”€ | é€‚ç”¨åœºæ™¯ |
|---------|------|---------|------|---------|
| **UDP** | < 1ms | å…è®¸ | 14 bytes | ç†æƒ³ï¼Œå†…ç½‘ç¯å¢ƒ |
| **TCP** | 2-5ms | é‡ä¼  | 14 bytes + TCPå¤´ | é˜²ç«å¢™å—é™ç¯å¢ƒ |

### 2.2 è¯­éŸ³ä¿¡é“å®ç°

```typescript
import dgram from 'dgram';
import net from 'net';

export class VoiceChannel {
  private udpSocket?: dgram.Socket;
  private tcpSocket?: net.Socket;
  private transport: 'udp' | 'tcp';
  
  constructor(private config: VoiceChannelConfig) {
    this.transport = config.preferredTransport;
  }
  
  /**
   * å‘é€è¯­éŸ³åŒ…
   */
  sendVoicePacket(packet: VoicePacket, target: string, port: number): void {
    const buffer = this.encodePacket(packet);
    
    if (this.transport === 'udp' && this.udpSocket) {
      this.udpSocket.send(buffer, port, target);
    } else if (this.transport === 'tcp' && this.tcpSocket) {
      // TCP éœ€è¦åŠ é•¿åº¦å‰ç¼€ï¼ˆ2 bytesï¼‰
      const lengthBuffer = Buffer.allocUnsafe(2);
      lengthBuffer.writeUInt16BE(buffer.length, 0);
      this.tcpSocket.write(Buffer.concat([lengthBuffer, buffer]));
    }
  }
  
  /**
   * ç¼–ç è¯­éŸ³åŒ…
   */
  private encodePacket(packet: VoicePacket): Buffer {
    const buffer = Buffer.allocUnsafe(14 + packet.data.length);
    buffer.writeUInt8(0x01, 0);                    // version
    buffer.writeUInt32BE(packet.senderId, 1);      // sender
    buffer.writeUInt32BE(packet.targetId, 5);      // target
    buffer.writeUInt32BE(packet.sequence, 9);      // sequence
    buffer.writeUInt8(packet.codec, 13);           // codec
    packet.data.copy(buffer, 14);                  // voice data
    return buffer;
  }
  
  /**
   * è§£ç è¯­éŸ³åŒ…
   */
  private decodePacket(buffer: Buffer): VoicePacket | null {
    if (buffer.length < 14) return null;
    
    return {
      version: buffer.readUInt8(0),
      senderId: buffer.readUInt32BE(1),
      targetId: buffer.readUInt32BE(5),
      sequence: buffer.readUInt32BE(9),
      codec: buffer.readUInt8(13),
      data: buffer.slice(14),
    };
  }
}
```

### 2.3 è¯­éŸ³ä¿¡é“ç«¯å£é…ç½®

```yaml
hub:
  voice_udp_port: 8444    # Hub è¯­éŸ³ UDP ç«¯å£
  voice_tcp_port: 8445    # Hub è¯­éŸ³ TCP ç«¯å£ï¼ˆé™çº§ï¼‰

edge:
  voice_udp_port: 8544    # Edge è¯­éŸ³ UDP ç«¯å£
  voice_tcp_port: 8545    # Edge è¯­éŸ³ TCP ç«¯å£ï¼ˆé™çº§ï¼‰
```

---

## ä¸‰ã€é›†ç¾¤è¿æ¥ç®¡ç†

### 3.1 è¿æ¥æ‹“æ‰‘

```
                      Hub Server
                           â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                â”‚                â”‚
      Edge 1 â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º Edge 2 â—„â”€â”€â”€â”€â”€â”€â–º Edge 3
        â”‚                  â”‚                â”‚
    (æ§åˆ¶+è¯­éŸ³)        (æ§åˆ¶+è¯­éŸ³)       (æ§åˆ¶+è¯­éŸ³)
```

**è¿æ¥è§„åˆ™**
- âœ… æ¯ä¸ª Edge å¿…é¡»ä¸ Hub å»ºç«‹è¿æ¥ï¼ˆæ§åˆ¶ + è¯­éŸ³åŒä¿¡é“ï¼‰
- âœ… æ¯ä¸ª Edge å¿…é¡»ä¸æ‰€æœ‰å…¶ä»– Edge å»ºç«‹è¿æ¥ï¼ˆæ§åˆ¶ + è¯­éŸ³åŒä¿¡é“ï¼‰
- âœ… æ‰€æœ‰è¿æ¥å¿…é¡»å»ºç«‹æˆåŠŸï¼ŒEdge æ‰ç®—åŠ å…¥æˆåŠŸ

**é—®é¢˜è®¨è®º**
> ğŸ’¡ **å»ºè®®ä¼˜åŒ–**ï¼šEdge-Edge ä¹‹é—´æ˜¯å¦çœŸçš„éœ€è¦å…¨è¿æ¥ï¼Ÿ
> 
> **å½“å‰è®¾è®¡**ï¼šN ä¸ª Edge éœ€è¦ N*(N-1) æ¡è¿æ¥
> - 3 ä¸ª Edge = 6 æ¡è¿æ¥
> - 10 ä¸ª Edge = 90 æ¡è¿æ¥
> - 50 ä¸ª Edge = 2450 æ¡è¿æ¥ âš ï¸
>
> **æ›¿ä»£æ–¹æ¡ˆ**ï¼šHub ä¸­è½¬æ¨¡å¼
> - Edge åªè¿æ¥ Hubï¼Œè¯­éŸ³åŒ…é€šè¿‡ Hub è½¬å‘
> - N ä¸ª Edge = N æ¡è¿æ¥
> - ç¼ºç‚¹ï¼šHub æˆä¸ºç“¶é¢ˆï¼Œå»¶è¿Ÿå¢åŠ ä¸€è·³
>
> **æ··åˆæ–¹æ¡ˆ**ï¼šåŠ¨æ€è·¯ç”±
> - åŒé¢‘é“ç”¨æˆ·åœ¨åŒ Edgeï¼šæ— éœ€è·¨æœåŠ¡å™¨
> - åŒé¢‘é“ç”¨æˆ·åœ¨ä¸åŒ Edgeï¼šå»ºç«‹ä¸´æ—¶ç›´è¿
> - éœ€è¦æ—¶å»ºç«‹ï¼Œç©ºé—²æ—¶æ–­å¼€
>
> **æ¨è**ï¼šå¦‚æœé›†ç¾¤è§„æ¨¡ < 10 ä¸ª Edgeï¼Œå…¨è¿æ¥å¯è¡Œï¼›å¦åˆ™è€ƒè™‘æ··åˆæ–¹æ¡ˆã€‚

### 3.2 Edge åŠ å…¥æµç¨‹ï¼ˆä¸²è¡ŒåŒ–ï¼‰

**è®¾è®¡ç›®æ ‡**
- ç¡®ä¿é›†ç¾¤çŠ¶æ€ä¸€è‡´æ€§
- é¿å…å¹¶å‘åŠ å…¥å¯¼è‡´çš„çŠ¶æ€å†²çª
- ç»™æ–° Edge è¶³å¤Ÿæ—¶é—´å»ºç«‹æ‰€æœ‰è¿æ¥

**åŠ å…¥æµç¨‹**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Edge N  â”‚                                           â”‚   Hub   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                           â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚                                                      â”‚
     â”‚  1. è¯·æ±‚åŠ å…¥ (edge.join)                             â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚                                                     â”‚
     â”‚                                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
     â”‚                                â”‚ Hub æ£€æŸ¥åŠ å…¥é”    â”‚â”‚
     â”‚                                â”‚ - å¦‚æœ‰å…¶ä»– Edge   â”‚â”‚
     â”‚                                â”‚   æ­£åœ¨åŠ å…¥ï¼ŒæŒ‚èµ·  â”‚â”‚
     â”‚                                â”‚ - å¦åˆ™ï¼Œè·å–é”    â”‚â”‚
     â”‚                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
     â”‚                                                     â”‚
     â”‚  2. è¿”å›é›†ç¾¤ä¿¡æ¯ + 60ç§’åŠ å…¥ä»¤ç‰Œ                       â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚  { peers: [...], token: "xxx", timeout: 60000 }  â”‚
     â”‚                                                     â”‚
     â”‚  3. ä¸æ¯ä¸ª Peer å»ºç«‹è¿æ¥ (æ§åˆ¶+è¯­éŸ³)                 â”‚
     â”œâ”€â”€â”€â”€â”€â–º Edge 1 â”€â”€â”                                  â”‚
     â”‚                 â”‚                                  â”‚
     â”œâ”€â”€â”€â”€â”€â–º Edge 2 â”€â”€â”¤                                  â”‚
     â”‚                 â”‚                                  â”‚
     â”œâ”€â”€â”€â”€â”€â–º Edge 3 â”€â”€â”¤                                  â”‚
     â”‚                 â”‚                                  â”‚
     â”‚  â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ (æ‰€æœ‰è¿æ¥å»ºç«‹å®Œæˆ)                â”‚
     â”‚                                                     â”‚
     â”‚  4. ç¡®è®¤åŠ å…¥æˆåŠŸ (edge.joinComplete)                â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚  { token: "xxx", peers: [1,2,3] }                 â”‚
     â”‚                                                     â”‚
     â”‚                                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
     â”‚                                â”‚ Hub éªŒè¯è¿æ¥çŠ¶æ€  â”‚â”‚
     â”‚                                â”‚ - æ£€æŸ¥æ‰€æœ‰ Peer   â”‚â”‚
     â”‚                                â”‚   æ˜¯å¦ç¡®è®¤è¿æ¥    â”‚â”‚
     â”‚                                â”‚ - é‡Šæ”¾åŠ å…¥é”      â”‚â”‚
     â”‚                                â”‚ - å¹¿æ’­æ–°æˆå‘˜      â”‚â”‚
     â”‚                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
     â”‚                                                     â”‚
     â”‚  5. ç¡®è®¤å“åº”                                         â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚  { success: true }                                 â”‚
     â”‚                                                     â”‚
     â”‚  6. Hub å¹¿æ’­æ–°æˆå‘˜åŠ å…¥é€šçŸ¥ï¼ˆç»™å…¶ä»– Edgeï¼‰            â”‚
     â”‚                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                                    â”‚ edge.peerJoined
     â”‚                                    â”‚ { id: N, ... }
     â”‚                                    â–¼               â”‚
```

**è¶…æ—¶å¤„ç†**
- å¦‚æœ 60 ç§’å†…æœªæ”¶åˆ° `edge.joinComplete`ï¼š
  - Hub é€šçŸ¥æ–° Edge åŠ å…¥å¤±è´¥
  - é‡Šæ”¾åŠ å…¥é”
  - å…è®¸ä¸‹ä¸€ä¸ª Edge åŠ å…¥

**å®ç°ä»£ç **

```typescript
// Hub Server
class EdgeJoinManager {
  private joinLock: {
    edgeId: number;
    token: string;
    startTime: number;
    timeout: NodeJS.Timeout;
  } | null = null;
  
  private pendingJoins: Array<{
    edgeId: number;
    resolve: (peers: PeerInfo[]) => void;
    reject: (error: Error) => void;
  }> = [];
  
  /**
   * Edge è¯·æ±‚åŠ å…¥
   */
  async requestJoin(edgeId: number): Promise<JoinResponse> {
    // æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»– Edge æ­£åœ¨åŠ å…¥
    if (this.joinLock) {
      // æŒ‚èµ·è¯·æ±‚ï¼Œç­‰å¾…å½“å‰åŠ å…¥å®Œæˆ
      return new Promise((resolve, reject) => {
        this.pendingJoins.push({ edgeId, resolve, reject });
        
        // è®¾ç½®ç­‰å¾…è¶…æ—¶ï¼ˆ5åˆ†é’Ÿï¼‰
        setTimeout(() => {
          const index = this.pendingJoins.findIndex(p => p.edgeId === edgeId);
          if (index !== -1) {
            this.pendingJoins.splice(index, 1);
            reject(new Error('Join queue timeout'));
          }
        }, 300000);
      });
    }
    
    // åˆ›å»ºåŠ å…¥ä»¤ç‰Œ
    const token = this.generateToken();
    const peers = this.getAllPeers();
    
    // è®¾ç½®åŠ å…¥é”
    this.joinLock = {
      edgeId,
      token,
      startTime: Date.now(),
      timeout: setTimeout(() => {
        this.handleJoinTimeout(edgeId);
      }, 60000), // 60ç§’è¶…æ—¶
    };
    
    return {
      success: true,
      token,
      peers,
      timeout: 60000,
    };
  }
  
  /**
   * Edge ç¡®è®¤åŠ å…¥å®Œæˆ
   */
  async confirmJoin(edgeId: number, token: string, connectedPeers: number[]): Promise<boolean> {
    // éªŒè¯ä»¤ç‰Œ
    if (!this.joinLock || this.joinLock.edgeId !== edgeId || this.joinLock.token !== token) {
      throw new Error('Invalid join token');
    }
    
    // éªŒè¯è¿æ¥çŠ¶æ€ï¼šæ£€æŸ¥æ‰€æœ‰ Peer æ˜¯å¦ç¡®è®¤è¿æ¥
    const allPeers = this.getAllPeers().map(p => p.id);
    const missingPeers = allPeers.filter(id => !connectedPeers.includes(id));
    
    if (missingPeers.length > 0) {
      throw new Error(`Missing connections to peers: ${missingPeers.join(',')}`);
    }
    
    // æ¸…é™¤è¶…æ—¶
    clearTimeout(this.joinLock.timeout);
    
    // é‡Šæ”¾é”
    this.joinLock = null;
    
    // å¹¿æ’­æ–°æˆå‘˜
    this.broadcastPeerJoined(edgeId);
    
    // å¤„ç†æŒ‚èµ·çš„åŠ å…¥è¯·æ±‚
    this.processNextJoin();
    
    return true;
  }
  
  /**
   * å¤„ç†åŠ å…¥è¶…æ—¶
   */
  private handleJoinTimeout(edgeId: number): void {
    if (this.joinLock && this.joinLock.edgeId === edgeId) {
      logger.warn(`Edge ${edgeId} join timeout, releasing lock`);
      
      // é€šçŸ¥ Edge åŠ å…¥å¤±è´¥
      this.notifyJoinFailed(edgeId, 'Join timeout');
      
      // é‡Šæ”¾é”
      this.joinLock = null;
      
      // å¤„ç†ä¸‹ä¸€ä¸ª
      this.processNextJoin();
    }
  }
  
  /**
   * å¤„ç†ä¸‹ä¸€ä¸ªæŒ‚èµ·çš„åŠ å…¥è¯·æ±‚
   */
  private processNextJoin(): void {
    if (this.pendingJoins.length > 0) {
      const next = this.pendingJoins.shift()!;
      this.requestJoin(next.edgeId)
        .then(response => next.resolve(response.peers))
        .catch(error => next.reject(error));
    }
  }
}
```

### 3.3 å¿ƒè·³æœºåˆ¶

**å¿ƒè·³è§„åˆ™**
- é¢‘ç‡ï¼šæ¯ç§’ 1 æ¬¡
- è¶…æ—¶ï¼šè¿ç»­ 3 ç§’æœªæ”¶åˆ°å¿ƒè·³è§†ä¸ºè¿æ¥ä¸­æ–­
- åº”ç”¨äºï¼šæ‰€æœ‰é›†ç¾¤å†…è¿æ¥ï¼ˆHub-Edge, Edge-Edgeï¼‰

**å®ç°**

```typescript
class HeartbeatManager {
  private lastHeartbeat = new Map<string, number>(); // connectionId -> timestamp
  private heartbeatInterval = 1000;  // 1 ç§’
  private heartbeatTimeout = 3000;   // 3 ç§’
  private timers = new Map<string, NodeJS.Timeout>();
  
  /**
   * å¯åŠ¨å¿ƒè·³å‘é€
   */
  startSending(connectionId: string, channel: RPCChannel): void {
    const timer = setInterval(() => {
      channel.notify('heartbeat.ping', { timestamp: Date.now() });
    }, this.heartbeatInterval);
    
    this.timers.set(connectionId, timer);
  }
  
  /**
   * è®°å½•æ”¶åˆ°å¿ƒè·³
   */
  recordHeartbeat(connectionId: string): void {
    this.lastHeartbeat.set(connectionId, Date.now());
  }
  
  /**
   * æ£€æŸ¥å¿ƒè·³è¶…æ—¶
   */
  checkTimeout(connectionId: string): boolean {
    const last = this.lastHeartbeat.get(connectionId);
    if (!last) return true;
    
    const elapsed = Date.now() - last;
    return elapsed > this.heartbeatTimeout;
  }
  
  /**
   * åœæ­¢å¿ƒè·³
   */
  stop(connectionId: string): void {
    const timer = this.timers.get(connectionId);
    if (timer) {
      clearInterval(timer);
      this.timers.delete(connectionId);
    }
    this.lastHeartbeat.delete(connectionId);
  }
}
```

### 3.4 è¿æ¥ä¸­æ–­æ£€æµ‹

**æ£€æµ‹æœºåˆ¶**
```typescript
class ConnectionMonitor {
  private heartbeat: HeartbeatManager;
  private checkInterval = 1000; // æ¯ç§’æ£€æŸ¥ä¸€æ¬¡
  
  startMonitoring(connectionId: string): void {
    setInterval(() => {
      if (this.heartbeat.checkTimeout(connectionId)) {
        this.handleDisconnect(connectionId);
      }
    }, this.checkInterval);
  }
  
  private handleDisconnect(connectionId: string): void {
    const connType = this.getConnectionType(connectionId);
    
    if (connType === 'hub') {
      this.handleHubDisconnect(connectionId);
    } else if (connType === 'edge') {
      this.handleEdgeDisconnect(connectionId);
    }
  }
}
```

---

## å››ã€æ•…éšœå¤„ç†ä¸é‡è¿ç­–ç•¥

### 4.1 Hub-Edge è¿æ¥ä¸­æ–­å¤„ç†

**æ£€æµ‹**ï¼šè¿ç»­ 3 ç§’æœªæ”¶åˆ°å¿ƒè·³

**å¤„ç†æµç¨‹**

```
Edge æ£€æµ‹åˆ° Hub è¿æ¥ä¸­æ–­
          â”‚
          â–¼
   å¯åŠ¨é‡è¿è®¡æ—¶å™¨ï¼ˆ10ç§’ï¼‰
          â”‚
          â”œâ”€â”€â–º æ¯ 2 ç§’å°è¯•é‡è¿
          â”‚
          â”œâ”€â”€â–º é‡è¿æˆåŠŸï¼Ÿ
          â”‚         â”‚
          â”‚         â”œâ”€ æ˜¯ â”€â”€â–º æ¢å¤æ­£å¸¸
          â”‚         â”‚         - æ¥æ”¶ç¼“å­˜çš„å¹¿æ’­
          â”‚         â”‚         - ç»§ç»­è¿è¡Œ
          â”‚         â”‚
          â”‚         â””â”€ å¦ â”€â”€â–º ç»§ç»­å°è¯•
          â”‚
          â–¼
    10 ç§’åä»æœªæˆåŠŸ
          â”‚
          â–¼
   æ‰§è¡Œå®Œå…¨æ–­å¼€æµç¨‹:
   1. æ–­å¼€æ‰€æœ‰ Edge-Edge è¿æ¥
   2. æ–­å¼€æ‰€æœ‰å®¢æˆ·ç«¯è¿æ¥
   3. æ¸…ç†æœ¬åœ°çŠ¶æ€
   4. é‡æ–°æ‰§è¡ŒåŠ å…¥æµç¨‹
```

**å®ç°ä»£ç **

```typescript
class HubConnectionManager {
  private reconnectTimeout = 10000; // 10 ç§’
  private reconnectInterval = 2000;  // 2 ç§’
  private reconnectTimer?: NodeJS.Timeout;
  private reconnectAttempts = 0;
  
  /**
   * å¤„ç† Hub è¿æ¥ä¸­æ–­
   */
  async handleHubDisconnect(): Promise<void> {
    logger.warn('Hub connection lost, attempting reconnect');
    
    const startTime = Date.now();
    this.reconnectAttempts = 0;
    
    return new Promise((resolve, reject) => {
      // è®¾ç½®æ€»è¶…æ—¶
      const timeout = setTimeout(() => {
        this.cancelReconnect();
        this.handleReconnectFailed('hub');
        reject(new Error('Hub reconnect timeout'));
      }, this.reconnectTimeout);
      
      // å®šæœŸé‡è¿
      this.reconnectTimer = setInterval(async () => {
        this.reconnectAttempts++;
        logger.info(`Hub reconnect attempt ${this.reconnectAttempts}`);
        
        try {
          await this.connectToHub();
          
          // é‡è¿æˆåŠŸ
          clearTimeout(timeout);
          clearInterval(this.reconnectTimer!);
          logger.info('Hub reconnected successfully');
          resolve();
        } catch (error) {
          logger.debug('Hub reconnect failed:', error);
        }
      }, this.reconnectInterval);
    });
  }
  
  /**
   * Hub é‡è¿å¤±è´¥ï¼Œæ‰§è¡Œå®Œå…¨æ–­å¼€
   */
  private async handleReconnectFailed(type: 'hub'): Promise<void> {
    logger.error(`${type} reconnect failed after ${this.reconnectTimeout}ms, performing full disconnect`);
    
    // 1. æ–­å¼€æ‰€æœ‰ Edge-Edge è¿æ¥
    await this.disconnectAllEdges();
    
    // 2. æ–­å¼€æ‰€æœ‰å®¢æˆ·ç«¯
    await this.disconnectAllClients();
    
    // 3. æ¸…ç†çŠ¶æ€
    this.clearState();
    
    // 4. å»¶è¿Ÿåé‡æ–°åŠ å…¥
    setTimeout(() => {
      logger.info('Attempting to rejoin cluster');
      this.joinCluster().catch(error => {
        logger.fatal('Failed to rejoin cluster:', error);
        process.exit(1);
      });
    }, 5000);
  }
  
  /**
   * æ–­å¼€æ‰€æœ‰å®¢æˆ·ç«¯
   */
  private async disconnectAllClients(): Promise<void> {
    logger.warn('Disconnecting all clients');
    
    for (const client of this.clients.values()) {
      client.disconnect('Server reconnecting');
    }
    
    this.clients.clear();
  }
}
```

**Hub ç«¯å¤„ç†**

```typescript
class HubEdgeManager {
  private edgeCache = new Map<number, {
    edge: EdgeConnection;
    messages: Message[];  // ç¼“å­˜çš„å¹¿æ’­æ¶ˆæ¯
  }>();
  
  /**
   * æ£€æµ‹åˆ° Edge æ–­å¼€
   */
  handleEdgeDisconnect(edgeId: number): void {
    const cached = this.edgeCache.get(edgeId);
    if (cached) {
      cached.messages = []; // æ¸…ç©ºç¼“å­˜ï¼Œå‡†å¤‡æ¥æ”¶æ–°æ¶ˆæ¯
      
      // å¯åŠ¨è¶…æ—¶è®¡æ—¶å™¨
      setTimeout(() => {
        const stillCached = this.edgeCache.get(edgeId);
        if (stillCached && !stillCached.edge.isConnected()) {
          // 10ç§’åä»æœªé‡è¿ï¼Œç§»é™¤ Edge
          logger.warn(`Edge ${edgeId} failed to reconnect, removing from cluster`);
          this.removeEdge(edgeId);
          this.broadcastEdgeLeft(edgeId);
        }
      }, 10000);
    }
  }
  
  /**
   * Edge é‡è¿æˆåŠŸ
   */
  handleEdgeReconnect(edgeId: number): void {
    const cached = this.edgeCache.get(edgeId);
    if (cached && cached.messages.length > 0) {
      logger.info(`Sending ${cached.messages.length} cached messages to Edge ${edgeId}`);
      
      // å‘é€ç¼“å­˜çš„æ¶ˆæ¯
      for (const msg of cached.messages) {
        cached.edge.send(msg);
      }
      
      cached.messages = [];
    }
  }
  
  /**
   * å¹¿æ’­æ¶ˆæ¯ï¼ˆè‡ªåŠ¨ç¼“å­˜ç»™æ–­å¼€çš„ Edgeï¼‰
   */
  broadcast(message: Message, exceptEdge?: number): void {
    for (const [edgeId, cached] of this.edgeCache) {
      if (edgeId === exceptEdge) continue;
      
      if (cached.edge.isConnected()) {
        cached.edge.send(message);
      } else {
        // Edge æ–­å¼€ï¼Œç¼“å­˜æ¶ˆæ¯
        cached.messages.push(message);
        
        // é™åˆ¶ç¼“å­˜å¤§å°
        if (cached.messages.length > 1000) {
          cached.messages.shift();
        }
      }
    }
  }
}
```

### 4.2 Edge-Edge è¿æ¥ä¸­æ–­å¤„ç†

**æ£€æµ‹**ï¼šè¿ç»­ 3 ç§’æœªæ”¶åˆ°å¿ƒè·³

**å¤„ç†æµç¨‹**

```
Edge A æ£€æµ‹åˆ°ä¸ Edge B è¿æ¥ä¸­æ–­
          â”‚
          â–¼
   å¯åŠ¨é‡è¿è®¡æ—¶å™¨ï¼ˆ3ç§’ï¼‰
          â”‚
          â”œâ”€â”€â–º æ¯ 1 ç§’å°è¯•é‡è¿
          â”‚
          â”œâ”€â”€â–º é‡è¿æˆåŠŸï¼Ÿ
          â”‚         â”‚
          â”‚         â”œâ”€ æ˜¯ â”€â”€â–º æ¢å¤æ­£å¸¸
          â”‚         â”‚
          â”‚         â””â”€ å¦ â”€â”€â–º ç»§ç»­å°è¯•
          â”‚
          â–¼
    3 ç§’åä»æœªæˆåŠŸ
          â”‚
          â–¼
   å‘ Hub æŠ¥å‘Šè¿æ¥ä¸­æ–­
          â”‚
          â–¼
   Hub å†³ç­–ï¼šæ¯”è¾ƒåŒæ–¹å®¢æˆ·ç«¯æ•°é‡
          â”‚
          â”œâ”€ Edge A å®¢æˆ·ç«¯è¾ƒå°‘ â”€â”€â–º Hub é€šçŸ¥ Edge A æ‰§è¡Œå®Œå…¨æ–­å¼€
          â”‚
          â””â”€ Edge B å®¢æˆ·ç«¯è¾ƒå°‘ â”€â”€â–º Hub é€šçŸ¥ Edge B æ‰§è¡Œå®Œå…¨æ–­å¼€
```

**å®ç°ä»£ç **

```typescript
class EdgePeerManager {
  private peers = new Map<number, PeerConnection>();
  private reconnectTimeout = 3000; // 3 ç§’
  
  /**
   * å¤„ç† Peer è¿æ¥ä¸­æ–­
   */
  async handlePeerDisconnect(peerId: number): Promise<void> {
    logger.warn(`Peer ${peerId} connection lost, attempting reconnect`);
    
    const startTime = Date.now();
    let attempts = 0;
    
    return new Promise((resolve, reject) => {
      const timeout = setTimeout(() => {
        clearInterval(timer);
        this.reportPeerDisconnect(peerId);
        reject(new Error(`Peer ${peerId} reconnect timeout`));
      }, this.reconnectTimeout);
      
      const timer = setInterval(async () => {
        attempts++;
        logger.debug(`Peer ${peerId} reconnect attempt ${attempts}`);
        
        try {
          await this.connectToPeer(peerId);
          
          clearTimeout(timeout);
          clearInterval(timer);
          logger.info(`Peer ${peerId} reconnected successfully`);
          resolve();
        } catch (error) {
          logger.debug(`Peer ${peerId} reconnect failed:`, error);
        }
      }, 1000);
    });
  }
  
  /**
   * å‘ Hub æŠ¥å‘Š Peer è¿æ¥å¤±è´¥
   */
  private async reportPeerDisconnect(peerId: number): Promise<void> {
    try {
      const response = await this.hubClient.call('edge.reportPeerDisconnect', {
        localEdgeId: this.config.serverId,
        remoteEdgeId: peerId,
        localClientCount: this.clients.size,
      });
      
      if (response.action === 'disconnect') {
        logger.warn('Hub instructed to disconnect and rejoin');
        await this.handleReconnectFailed('edge');
      }
    } catch (error) {
      logger.error('Failed to report peer disconnect:', error);
    }
  }
}
```

**Hub ç«¯ä»²è£**

```typescript
class HubPeerManager {
  /**
   * å¤„ç† Edge æŠ¥å‘Š Peer è¿æ¥å¤±è´¥
   */
  async handlePeerDisconnectReport(
    localEdgeId: number,
    remoteEdgeId: number,
    localClientCount: number
  ): Promise<{ action: 'wait' | 'disconnect' }> {
    
    // è·å–ä¸¤ä¸ª Edge çš„çŠ¶æ€
    const localEdge = this.edges.get(localEdgeId);
    const remoteEdge = this.edges.get(remoteEdgeId);
    
    if (!localEdge || !remoteEdge) {
      return { action: 'disconnect' };
    }
    
    // è·å–è¿œç¨‹ Edge çš„å®¢æˆ·ç«¯æ•°é‡
    const remoteClientCount = await this.getEdgeClientCount(remoteEdgeId);
    
    logger.info(`Peer disconnect: Edge ${localEdgeId} (${localClientCount} clients) <-> Edge ${remoteEdgeId} (${remoteClientCount} clients)`);
    
    // æ¯”è¾ƒå®¢æˆ·ç«¯æ•°é‡ï¼Œè®©å®¢æˆ·ç«¯å°‘çš„ Edge æ–­å¼€é‡è¿
    if (localClientCount < remoteClientCount) {
      logger.info(`Instructing Edge ${localEdgeId} to disconnect (fewer clients)`);
      return { action: 'disconnect' };
    } else if (localClientCount > remoteClientCount) {
      logger.info(`Instructing Edge ${remoteEdgeId} to disconnect (fewer clients)`);
      
      // é€šçŸ¥è¿œç¨‹ Edge æ–­å¼€
      this.notifyEdgeDisconnect(remoteEdgeId);
      
      return { action: 'wait' };
    } else {
      // å®¢æˆ·ç«¯æ•°é‡ç›¸åŒï¼Œè®© ID è¾ƒå°çš„æ–­å¼€
      if (localEdgeId < remoteEdgeId) {
        return { action: 'disconnect' };
      } else {
        this.notifyEdgeDisconnect(remoteEdgeId);
        return { action: 'wait' };
      }
    }
  }
  
  /**
   * é€šçŸ¥ Edge æ‰§è¡Œæ–­å¼€é‡è¿
   */
  private notifyEdgeDisconnect(edgeId: number): void {
    const edge = this.edges.get(edgeId);
    if (edge) {
      edge.send({
        type: 'notification',
        method: 'edge.forceDisconnect',
        params: { reason: 'Peer connection failed, fewer clients' },
        timestamp: Date.now(),
      });
    }
  }
}
```

### 4.3 å®Œæ•´æ–­å¼€æµç¨‹

**è§¦å‘æ¡ä»¶**
- Hub é‡è¿è¶…æ—¶ï¼ˆ10 ç§’ï¼‰
- Hub é€šçŸ¥å¼ºåˆ¶æ–­å¼€ï¼ˆEdge-Edge è¿æ¥å¤±è´¥ä»²è£ï¼‰

**æµç¨‹**

```typescript
class EdgeServer {
  /**
   * æ‰§è¡Œå®Œæ•´æ–­å¼€æµç¨‹
   */
  async performFullDisconnect(): Promise<void> {
    logger.warn('=== Starting full disconnect procedure ===');
    
    // 1. é€šçŸ¥æ‰€æœ‰å®¢æˆ·ç«¯
    logger.info('Step 1/5: Notifying clients');
    for (const client of this.clients.values()) {
      client.sendServerMessage('Server is reconnecting, please wait...');
    }
    
    // 2. æ–­å¼€æ‰€æœ‰ Edge-Edge è¿æ¥
    logger.info('Step 2/5: Disconnecting from peers');
    for (const peer of this.peers.values()) {
      peer.disconnect();
    }
    this.peers.clear();
    
    // 3. æ–­å¼€æ‰€æœ‰å®¢æˆ·ç«¯
    logger.info('Step 3/5: Disconnecting clients');
    for (const client of this.clients.values()) {
      client.disconnect('Server reconnecting');
    }
    this.clients.clear();
    
    // 4. æ–­å¼€ Hub
    logger.info('Step 4/5: Disconnecting from Hub');
    if (this.hubClient) {
      this.hubClient.disconnect();
    }
    
    // 5. æ¸…ç†çŠ¶æ€
    logger.info('Step 5/5: Clearing state');
    this.clearState();
    
    logger.warn('=== Full disconnect complete ===');
    
    // 6. å»¶è¿Ÿåé‡æ–°åŠ å…¥
    logger.info('Waiting 5 seconds before rejoin...');
    await this.sleep(5000);
    
    logger.info('=== Starting rejoin procedure ===');
    await this.joinCluster();
  }
  
  /**
   * æ¸…ç†æ‰€æœ‰çŠ¶æ€
   */
  private clearState(): void {
    this.channels.clear();
    this.users.clear();
    this.sessions.clear();
    this.voiceTargets.clear();
    // ä¿ç•™ï¼šé…ç½®ã€è¯ä¹¦ç­‰é™æ€æ•°æ®
  }
  
  private sleep(ms: number): Promise<void> {
    return new Promise(resolve => setTimeout(resolve, ms));
  }
}
```

### 4.4 æ•…éšœåœºæ™¯æ€»ç»“

| åœºæ™¯ | æ£€æµ‹æ—¶é—´ | é‡è¿æ—¶é—´ | å¤±è´¥åå¤„ç† |
|------|---------|---------|-----------|
| **Hub æ–­å¼€** | 3 ç§’ | 10 ç§’ | å®Œå…¨æ–­å¼€ï¼Œé‡æ–°åŠ å…¥ |
| **Peer æ–­å¼€** | 3 ç§’ | 3 ç§’ | å‘ Hub æŠ¥å‘Šï¼Œç­‰å¾…ä»²è£ |
| **å®¢æˆ·ç«¯æ–­å¼€** | 3 ç§’ | - | æ¸…ç†ä¼šè¯ï¼Œé€šçŸ¥å…¶ä»–ç”¨æˆ· |

### 4.5 æ¶ˆæ¯ç¼“å­˜ç­–ç•¥

**Hub ç¼“å­˜å¹¿æ’­æ¶ˆæ¯**
- ç¼“å­˜æ¡ä»¶ï¼šEdge æ–­å¼€ä½†æœªè¶…è¿‡ 10 ç§’
- ç¼“å­˜å¤§å°ï¼šæœ€å¤š 1000 æ¡æ¶ˆæ¯
- ç¼“å­˜ç­–ç•¥ï¼šFIFOï¼Œè¶…è¿‡é™åˆ¶åˆ é™¤æœ€æ—§æ¶ˆæ¯
- å‘é€æ—¶æœºï¼šEdge é‡è¿æˆåŠŸåç«‹å³å‘é€

**Edge ç¼“å­˜å®¢æˆ·ç«¯æ¶ˆæ¯**
- ä¸ç¼“å­˜ï¼šå®¢æˆ·ç«¯æ–­å¼€åç«‹å³æ¸…ç†
- ç†ç”±ï¼šå®¢æˆ·ç«¯é‡è¿åä¼šè¯·æ±‚å®Œæ•´çŠ¶æ€

**é—®é¢˜è®¨è®º**
> âš ï¸ **æ¶ˆæ¯ç¼“å­˜çš„æƒè¡¡**
>
> **ä¼˜ç‚¹**ï¼š
> - å‡å°‘ Edge é‡è¿åçš„çŠ¶æ€ä¸ä¸€è‡´
> - é¿å…ä¸¢å¤±é‡è¦æ§åˆ¶æ¶ˆæ¯
>
> **ç¼ºç‚¹**ï¼š
> - å†…å­˜å ç”¨ï¼ˆ1000 æ¡ Ã— æ¯æ¡ ~500 bytes = 500KBï¼‰
> - å¯èƒ½æ¥æ”¶è¿‡æ—¶æ¶ˆæ¯
> - å¤æ‚åº¦å¢åŠ 
>
> **æ›¿ä»£æ–¹æ¡ˆ**ï¼š
> - ä¸ç¼“å­˜ï¼ŒEdge é‡è¿åè¯·æ±‚å®Œæ•´å¿«ç…§
> - æ›´ç®€å•ï¼Œä½† Edge é‡è¿å¼€é”€æ›´å¤§
>
> **æ¨è**ï¼šä¿ç•™ç¼“å­˜æœºåˆ¶ï¼Œä½†é™åˆ¶å¤§å°å’Œæ—¶é—´

### æ¨èç»„åˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Hub Server                         â”‚
â”‚                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ æ§åˆ¶ä¿¡é“ç›‘å¬      â”‚      â”‚ è¯­éŸ³ä¿¡é“ç›‘å¬      â”‚    â”‚
â”‚  â”‚ WebSocket:8443   â”‚      â”‚ UDP:8444         â”‚    â”‚
â”‚  â”‚ MessagePack      â”‚      â”‚ è‡ªå®šä¹‰åè®®        â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚                        â”‚
              â”‚ MessagePack/WS         â”‚ UDP Voice
              â”‚                        â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Edge Server 1   â”‚â—„â”€â”€â”€â”¤  Edge Server 2   â”‚
    â”‚                  â”‚    â”‚                  â”‚
    â”‚  Control: WS     â”‚    â”‚  Control: WS     â”‚
    â”‚  Voice: UDP      â”‚    â”‚  Voice: UDP      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         UDP Voice ç›´è¿
```

### å®ç°å»ºè®®

**1. æ§åˆ¶ä¿¡é“ (MessagePack over WebSocket)**

```typescript
// hub-control-channel.ts
import WebSocket from 'ws';
import { pack, unpack } from 'msgpackr';

export class HubControlChannel {
  private wss: WebSocket.Server;
  private edges: Map<number, WebSocket> = new Map();
  
  constructor(port: number) {
    this.wss = new WebSocket.Server({ port });
    this.wss.on('connection', this.handleConnection.bind(this));
  }
  
  private handleConnection(ws: WebSocket) {
    ws.on('message', (data: Buffer) => {
      const msg = unpack(data);
      this.handleMessage(ws, msg);
    });
  }
  
  broadcast(msg: ControlMessage) {
    const packed = pack(msg);
    for (const [edgeId, ws] of this.edges) {
      if (ws.readyState === WebSocket.OPEN) {
        ws.send(packed);
      }
    }
  }
}
```

**2. è¯­éŸ³ä¿¡é“ (åŸå§‹ UDP)**

```typescript
// hub-voice-channel.ts
import dgram from 'dgram';

export class HubVoiceChannel {
  private socket: dgram.Socket;
  private routes: Map<number, RemoteInfo> = new Map(); // sessionId -> address
  
  constructor(port: number) {
    this.socket = dgram.createSocket('udp4');
    this.socket.bind(port);
    this.socket.on('message', this.handleVoicePacket.bind(this));
  }
  
  private handleVoicePacket(msg: Buffer, rinfo: dgram.RemoteInfo) {
    const packet = this.parsePacket(msg);
    const targets = this.resolveTargets(packet);
    
    // è½¬å‘ç»™ç›®æ ‡ Edge
    for (const target of targets) {
      const route = this.routes.get(target);
      if (route) {
        this.socket.send(msg, route.port, route.address);
      }
    }
  }
  
  private parsePacket(data: Buffer): VoicePacket {
    return {
      version: data.readUInt8(0),
      senderId: data.readUInt32BE(1),
      target: data.readUInt32BE(5),
      sequence: data.readUInt32BE(9),
      codec: data.readUInt8(13),
      data: data.slice(14),
    };
  }
}
```

---

## äº”ã€æ€§èƒ½å¯¹æ¯”

### å¸¦å®½å¯¹æ¯”ï¼ˆ100 ç”¨æˆ·åŒæ—¶è¯´è¯ï¼‰

| æ–¹æ¡ˆ | å•åŒ…å¤§å° | åŒ…é€Ÿç‡ | å•ç”¨æˆ·å¸¦å®½ | 100ç”¨æˆ·æ€»å¸¦å®½ |
|------|---------|--------|-----------|-------------|
| **åŸå§‹ UDP** | 74 bytes | 50/s | 29.6 kbps | 2.96 Mbps |
| **WebRTC** | 99 bytes | 50/s | 39.6 kbps | 3.96 Mbps |
| **QUIC** | 90 bytes | 50/s | 36.0 kbps | 3.60 Mbps |

**ç»“è®º**: åŸå§‹ UDP æ¯” WebRTC èŠ‚çœ **25%** å¸¦å®½

### å»¶è¿Ÿå¯¹æ¯”

| æ–¹æ¡ˆ | è¿æ¥å»ºç«‹ | å•åŒ…å»¶è¿Ÿ | æ€»å»¶è¿Ÿ |
|------|---------|---------|--------|
| **åŸå§‹ UDP** | 0 ms | < 1 ms | **< 1 ms** |
| **WebRTC** | 500-1000 ms | 2-5 ms | **10-20 ms** |
| **QUIC** | 100-200 ms | 2-3 ms | **5-10 ms** |

**ç»“è®º**: åŸå§‹ UDP å»¶è¿Ÿæœ€ä½

### å®ç°å¤æ‚åº¦å¯¹æ¯”

| æ–¹æ¡ˆ | ä»£ç è¡Œæ•° | å¤–éƒ¨ä¾èµ– | è°ƒè¯•éš¾åº¦ |
|------|---------|---------|---------|
| **åŸå§‹ UDP** | ~100 è¡Œ | 0 | ç®€å• |
| **WebRTC** | ~500 è¡Œ | 3+ | å›°éš¾ |
| **QUIC** | ~300 è¡Œ | 2+ | ä¸­ç­‰ |

---

## å…­ã€æœ€ç»ˆæ¨è

### ç”Ÿäº§ç¯å¢ƒæ¨èé…ç½®

```yaml
control_channel:
  type: websocket
  encoding: messagepack
  port: 8443
  tls: true
  compression: false  # MessagePack å·²ç»å¾ˆç´§å‡‘
  heartbeat_interval: 30s
  reconnect_backoff: 1s -> 30s

voice_channel:
  type: udp
  port: 8444
  header_size: 14
  max_packet_size: 1400  # é¿å… IP åˆ†ç‰‡
  rate_limit: 100 pps    # æ¯ä¸ªå®¢æˆ·ç«¯
  encryption: aes-ocb2   # åº”ç”¨å±‚åŠ å¯†
```

### è¿ç§»è·¯å¾„

**é˜¶æ®µ 1: åŸºç¡€å®ç°**ï¼ˆå½“å‰ â†’ 1å‘¨ï¼‰
- å®ç° JSON over WebSocket æ§åˆ¶ä¿¡é“
- å®ç°åŸå§‹ UDP è¯­éŸ³ä¿¡é“
- åŸºæœ¬è·¯ç”±åŠŸèƒ½

**é˜¶æ®µ 2: ä¼˜åŒ–**ï¼ˆ1å‘¨ â†’ 2å‘¨ï¼‰
- å‡çº§åˆ° MessagePack
- æ·»åŠ å¿ƒè·³å’Œé‡è¿
- å®Œå–„é”™è¯¯å¤„ç†

**é˜¶æ®µ 3: ç”Ÿäº§å¼ºåŒ–**ï¼ˆ2å‘¨ â†’ 4å‘¨ï¼‰
- æ·»åŠ ç›‘æ§æŒ‡æ ‡
- å®ç°æ‹¥å¡æ§åˆ¶
- åŠ å¯†å’Œè®¤è¯

---

## ä¸ƒã€å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆä¸ç”¨ gRPCï¼Ÿ
**A**: gRPC é€‚åˆå¾®æœåŠ¡ RPC è°ƒç”¨ï¼Œä½†å¯¹äºæŒä¹…è¿æ¥çš„æ¶ˆæ¯æ¨é€ï¼ŒWebSocket æ›´ç®€å•ã€‚è¯­éŸ³æ•°æ®ç”¨ gRPC Stream å¼€é”€å¤ªå¤§ï¼ˆHTTP/2 å¤´éƒ¨ï¼‰ã€‚

### Q2: UDP ä¸¢åŒ…æ€ä¹ˆåŠï¼Ÿ
**A**: è¯­éŸ³ç¼–è§£ç å™¨ï¼ˆå¦‚ Opusï¼‰æœ‰å®¹é”™èƒ½åŠ›ï¼Œ1-2% ä¸¢åŒ…ä¸å½±å“éŸ³è´¨ã€‚å…³é”®æ§åˆ¶ä¿¡ä»¤èµ° TCPã€‚

### Q3: å¦‚ä½•ä¿è¯è¯­éŸ³åŒ…å®‰å…¨ï¼Ÿ
**A**: åº”ç”¨å±‚åŠ å¯†ï¼ˆAES-OCB2ï¼‰ï¼Œæ¯ä¸ªå®¢æˆ·ç«¯ç‹¬ç«‹å¯†é’¥ï¼ŒUDP åŒ…å¤´ä¸åŠ å¯†ä»¥ä¾¿è·¯ç”±ã€‚

### Q4: Edge-Edge å¦‚ä½•æ‰¾åˆ°å¯¹æ–¹ï¼Ÿ
**A**: Hub ç»´æŠ¤ Edge åœ°å€æ³¨å†Œè¡¨ï¼Œé€šè¿‡æ§åˆ¶ä¿¡é“äº¤æ¢ IP:Portã€‚

### Q5: æœªæ¥æ˜¯å¦å¯èƒ½å‡çº§åˆ° QUICï¼Ÿ
**A**: å¯ä»¥ï¼Œä½†éœ€è¦ç­‰å¾… Node.js ç”Ÿæ€æˆç†Ÿã€‚å½“å‰æ–¹æ¡ˆå·²è¶³å¤Ÿé«˜æ•ˆã€‚

---

## äº”ã€RPC æ–¹æ³•å®šä¹‰

### 5.1 Hub æä¾›çš„ RPC æ–¹æ³•

```typescript
// Edge -> Hub
interface HubRPCMethods {
  // åŠ å…¥é›†ç¾¤
  'edge.join': (params: {
    serverId: number;
    name: string;
    host: string;
    port: number;
    voicePort: number;
    capacity: number;
  }) => Promise<{
    success: boolean;
    token: string;
    peers: Array<{
      id: number;
      name: string;
      host: string;
      port: number;
      voicePort: number;
    }>;
    timeout: number;
  }>;
  
  // ç¡®è®¤åŠ å…¥å®Œæˆ
  'edge.joinComplete': (params: {
    token: string;
    connectedPeers: number[];
  }) => Promise<{
    success: boolean;
  }>;
  
  // æŠ¥å‘Š Peer è¿æ¥å¤±è´¥
  'edge.reportPeerDisconnect': (params: {
    localEdgeId: number;
    remoteEdgeId: number;
    localClientCount: number;
  }) => Promise<{
    action: 'wait' | 'disconnect';
  }>;
  
  // è·å–é›†ç¾¤çŠ¶æ€
  'cluster.getStatus': () => Promise<{
    edges: Array<{
      id: number;
      name: string;
      clientCount: number;
      status: 'online' | 'reconnecting';
    }>;
  }>;
}
```

### 5.2 Hub å‘é€çš„é€šçŸ¥

```typescript
// Hub -> Edge (é€šçŸ¥ï¼Œæ— éœ€å“åº”)
interface HubNotifications {
  // æ–° Edge åŠ å…¥
  'edge.peerJoined': {
    id: number;
    name: string;
    host: string;
    port: number;
    voicePort: number;
  };
  
  // Edge ç¦»å¼€
  'edge.peerLeft': {
    id: number;
  };
  
  // å¼ºåˆ¶æ–­å¼€
  'edge.forceDisconnect': {
    reason: string;
  };
  
  // æ•°æ®åŒæ­¥é€šçŸ¥
  'sync.channelUpdate': {
    channelId: number;
    name: string;
    // ... å…¶ä»–é¢‘é“æ•°æ®
  };
  
  'sync.aclUpdate': {
    channelId: number;
    acls: any[];
  };
}
```

### 5.3 Edge æä¾›çš„ RPC æ–¹æ³•

```typescript
// Hub/Edge -> Edge
interface EdgeRPCMethods {
  // è·å–å®¢æˆ·ç«¯æ•°é‡
  'edge.getClientCount': () => Promise<{
    count: number;
  }>;
  
  // è·å–æœåŠ¡å™¨çŠ¶æ€
  'edge.getStatus': () => Promise<{
    uptime: number;
    clientCount: number;
    memoryUsage: number;
    cpuUsage: number;
  }>;
}
```

---

## å…­ã€å®ç°æ¸…å•

### 6.1 éœ€è¦ç§»é™¤çš„ä»£ç 

```bash
# ç§»é™¤ Protobuf + gRPC ç›¸å…³
node/packages/protocol/proto/*.proto           # Protobuf å®šä¹‰
node/packages/protocol/src/generated/          # ç”Ÿæˆçš„ä»£ç 
node/packages/hub-server/src/grpc-service.ts  # gRPC æœåŠ¡å®ç°
node/packages/edge-server/src/hub-client.ts   # éƒ¨åˆ† gRPC å®¢æˆ·ç«¯ä»£ç 

# ç§»é™¤ä¾èµ–
package.json: nice-grpc, @grpc/grpc-js, ts-proto
```

### 6.2 éœ€è¦å®ç°çš„æ¨¡å—

**é€šç”¨æ¨¡å—** (`packages/common/`)
- [ ] `src/rpc/rpc-channel.ts` - RPC é€šé“å®ç°
- [ ] `src/rpc/types.ts` - RPC ç±»å‹å®šä¹‰
- [ ] `src/voice/voice-packet.ts` - è¯­éŸ³åŒ…ç¼–è§£ç 
- [ ] `src/voice/voice-channel.ts` - è¯­éŸ³ä¿¡é“å®ç°
- [ ] `src/heartbeat/heartbeat-manager.ts` - å¿ƒè·³ç®¡ç†å™¨
- [ ] `src/connection/connection-monitor.ts` - è¿æ¥ç›‘æ§å™¨

**Hub Server** (`packages/hub-server/`)
- [ ] `src/control/control-server.ts` - æ§åˆ¶ä¿¡é“æœåŠ¡ç«¯
- [ ] `src/control/edge-join-manager.ts` - Edge åŠ å…¥ç®¡ç†å™¨
- [ ] `src/control/edge-manager.ts` - Edge è¿æ¥ç®¡ç†å™¨
- [ ] `src/control/message-cache.ts` - æ¶ˆæ¯ç¼“å­˜
- [ ] `src/voice/voice-router.ts` - è¯­éŸ³è·¯ç”±å™¨
- [ ] `src/rpc/hub-rpc-handler.ts` - Hub RPC å¤„ç†å™¨

**Edge Server** (`packages/edge-server/`)
- [ ] `src/control/hub-connection.ts` - Hub è¿æ¥ç®¡ç†
- [ ] `src/control/peer-manager.ts` - Peer è¿æ¥ç®¡ç†
- [ ] `src/control/reconnect-manager.ts` - é‡è¿ç®¡ç†å™¨
- [ ] `src/voice/voice-forwarder.ts` - è¯­éŸ³è½¬å‘å™¨
- [ ] `src/rpc/edge-rpc-handler.ts` - Edge RPC å¤„ç†å™¨
- [ ] `src/lifecycle/disconnect-handler.ts` - å®Œå…¨æ–­å¼€å¤„ç†å™¨

### 6.3 å®ç°ä¼˜å…ˆçº§

**ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€é€šä¿¡** (1-2 å‘¨)
1. âœ… RPC Channel å®ç°
2. âœ… æ§åˆ¶ä¿¡é“æœåŠ¡ç«¯/å®¢æˆ·ç«¯
3. âœ… è¯­éŸ³åŒ…ç¼–è§£ç 
4. âœ… åŸºæœ¬çš„ Hub-Edge è¿æ¥

**ç¬¬äºŒé˜¶æ®µï¼šé›†ç¾¤ç®¡ç†** (1-2 å‘¨)
1. âœ… Edge åŠ å…¥æµç¨‹ï¼ˆä¸²è¡ŒåŒ–ï¼‰
2. âœ… Edge-Edge è¿æ¥å»ºç«‹
3. âœ… å¿ƒè·³æœºåˆ¶
4. âœ… è¿æ¥ç›‘æ§

**ç¬¬ä¸‰é˜¶æ®µï¼šæ•…éšœå¤„ç†** (1-2 å‘¨)
1. âœ… Hub é‡è¿é€»è¾‘
2. âœ… Peer é‡è¿é€»è¾‘
3. âœ… æ¶ˆæ¯ç¼“å­˜
4. âœ… å®Œå…¨æ–­å¼€æµç¨‹

**ç¬¬å››é˜¶æ®µï¼šä¼˜åŒ–å’Œæµ‹è¯•** (1-2 å‘¨)
1. âœ… æ€§èƒ½ä¼˜åŒ–
2. âœ… å‹åŠ›æµ‹è¯•
3. âœ… æ•…éšœæ³¨å…¥æµ‹è¯•
4. âœ… æ–‡æ¡£å®Œå–„

---

## ä¸ƒã€æ€§èƒ½æŒ‡æ ‡

### 7.1 å»¶è¿ŸæŒ‡æ ‡

| æ“ä½œ | ç›®æ ‡å»¶è¿Ÿ | è¯´æ˜ |
|------|---------|------|
| RPC è°ƒç”¨ | < 10ms | Hub-Edge å•æ¬¡ RPC |
| è¯­éŸ³åŒ…è½¬å‘ | < 5ms | Hub è½¬å‘è¯­éŸ³åŒ… |
| å¿ƒè·³å“åº” | < 5ms | Ping-Pong å¾€è¿” |
| Edge åŠ å…¥ | < 5s | åŒ…å«æ‰€æœ‰è¿æ¥å»ºç«‹ |

### 7.2 ååé‡æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | è¯´æ˜ |
|------|--------|------|
| æ§åˆ¶æ¶ˆæ¯ | 1000 msg/s | Hub å¹¿æ’­èƒ½åŠ› |
| è¯­éŸ³åŒ…è½¬å‘ | 10000 pkt/s | Hub è½¬å‘èƒ½åŠ› |
| å¹¶å‘ Edge | 50 ä¸ª | Hub å¯ç®¡ç†çš„ Edge æ•°é‡ |
| å®¢æˆ·ç«¯/Edge | 500 ä¸ª | å•ä¸ª Edge æ‰¿è½½èƒ½åŠ› |

### 7.3 å¯é æ€§æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | è¯´æ˜ |
|------|--------|------|
| Hub é‡è¿æˆåŠŸç‡ | > 95% | 10ç§’å†…é‡è¿æˆåŠŸ |
| Peer é‡è¿æˆåŠŸç‡ | > 90% | 3ç§’å†…é‡è¿æˆåŠŸ |
| æ¶ˆæ¯ä¸¢å¤±ç‡ | < 0.1% | æ§åˆ¶æ¶ˆæ¯ä¸¢å¤±ç‡ |
| è¯­éŸ³ä¸¢åŒ…ç‡ | < 2% | å¯æ¥å—çš„ä¸¢åŒ… |

---

## å…«ã€ç›‘æ§å’Œè°ƒè¯•

### 8.1 ç›‘æ§æŒ‡æ ‡

```typescript
interface ClusterMetrics {
  // è¿æ¥æŒ‡æ ‡
  connections: {
    hubConnected: boolean;
    peerCount: number;
    peerConnected: number[];
    clientCount: number;
  };
  
  // æ€§èƒ½æŒ‡æ ‡
  performance: {
    controlLatency: number;      // ms
    voiceLatency: number;        // ms
    controlThroughput: number;   // msg/s
    voiceThroughput: number;     // pkt/s
  };
  
  // å¯é æ€§æŒ‡æ ‡
  reliability: {
    hubReconnects: number;
    peerReconnects: number;
    messagesCached: number;
    messagesLost: number;
  };
  
  // å¿ƒè·³æŒ‡æ ‡
  heartbeat: {
    hubLastPing: number;         // ms ago
    peersLastPing: Map<number, number>; // edgeId -> ms ago
  };
}
```

### 8.2 æ—¥å¿—çº§åˆ«

```typescript
// ERROR: ä¸¥é‡é”™è¯¯ï¼Œéœ€è¦ç«‹å³å¤„ç†
logger.error('Hub connection failed after 10s');

// WARN: è­¦å‘Šï¼Œå¯èƒ½å½±å“åŠŸèƒ½
logger.warn('Peer connection lost, attempting reconnect');

// INFO: é‡è¦äº‹ä»¶
logger.info('Edge joined successfully');

// DEBUG: è°ƒè¯•ä¿¡æ¯
logger.debug('RPC call: edge.join');

// TRACE: è¯¦ç»†è·Ÿè¸ªï¼ˆç”Ÿäº§ç¯å¢ƒå…³é—­ï¼‰
logger.trace('Heartbeat received from Edge 1');
```

### 8.3 è°ƒè¯•å·¥å…·

```bash
# å®æ—¶ç›‘æ§
npm run monitor

# è¾“å‡ºç¤ºä¾‹
=== ShitSpeak Cluster Monitor ===
Hub: Connected (latency: 5ms)
Peers: 3/3 connected
  - Edge 1: OK (latency: 3ms, clients: 45)
  - Edge 2: OK (latency: 4ms, clients: 38)
  - Edge 3: OK (latency: 6ms, clients: 52)
Clients: 135 total
Messages: 1523 sent, 0 cached, 0 lost
Uptime: 2h 34m 12s

# æ•…éšœæ³¨å…¥æµ‹è¯•
npm run test:failover

# å‹åŠ›æµ‹è¯•
npm run test:stress -- --edges=10 --clients-per-edge=100
```

---

## ä¹ã€å¸¸è§é—®é¢˜ä¸è§£ç­”

### Q1: ä¸ºä»€ä¹ˆ Edge åŠ å…¥è¦ä¸²è¡ŒåŒ–ï¼Ÿ

**A**: é¿å…å¹¶å‘åŠ å…¥å¯¼è‡´çš„çŠ¶æ€ä¸ä¸€è‡´ã€‚ä¾‹å¦‚ï¼š
- Edge A å’Œ Edge B åŒæ—¶åŠ å…¥
- Edge A æ”¶åˆ°çš„ Peer åˆ—è¡¨ä¸åŒ…å« Edge B
- Edge B æ”¶åˆ°çš„ Peer åˆ—è¡¨ä¸åŒ…å« Edge A
- å¯¼è‡´ A å’Œ B ä¹‹é—´æ— æ³•å»ºç«‹è¿æ¥

ä¸²è¡ŒåŒ–ç¡®ä¿æ¯ä¸ª Edge åŠ å…¥æ—¶ï¼Œéƒ½èƒ½çœ‹åˆ°å®Œæ•´çš„é›†ç¾¤çŠ¶æ€ã€‚

### Q2: 60 ç§’åŠ å…¥æ—¶é—´æ˜¯å¦å¤ªé•¿ï¼Ÿ

**A**: å–å†³äºé›†ç¾¤è§„æ¨¡ï¼š
- 10 ä¸ª Edgeï¼šå»ºç«‹ 10 ä¸ªè¿æ¥ï¼Œæ¯ä¸ª < 1sï¼Œæ€»è®¡ < 10sï¼ˆè¶³å¤Ÿï¼‰
- 50 ä¸ª Edgeï¼šå»ºç«‹ 50 ä¸ªè¿æ¥ï¼Œæ€»è®¡ < 50sï¼ˆåˆšå¥½å¤Ÿï¼‰

å¦‚æœç»å¸¸è¶…æ—¶ï¼Œå¯ä»¥ï¼š
- å¢åŠ è¶…æ—¶æ—¶é—´åˆ° 120s
- å¹¶è¡Œå»ºç«‹è¿æ¥ï¼ˆä½†å¢åŠ å¤æ‚åº¦ï¼‰
- ä¼˜åŒ–è¿æ¥å»ºç«‹é€Ÿåº¦

### Q3: ä¸ºä»€ä¹ˆ Hub é‡è¿ 10 ç§’ï¼ŒPeer é‡è¿ 3 ç§’ï¼Ÿ

**A**: 
- **Hub æ›´å…³é”®**ï¼šHub æ–­å¼€æ„å‘³ç€æ— æ³•åŒæ­¥æ•°æ®ï¼Œç»™æ›´é•¿é‡è¿æ—¶é—´
- **Peer å¯é™çº§**ï¼šPeer æ–­å¼€åªå½±å“è·¨æœåŠ¡å™¨è¯­éŸ³ï¼Œå¯ä»¥å¿«é€Ÿå†³ç­–

å¦‚æœä¸¤ä¸ª Edge éƒ½é•¿æ—¶é—´é‡è¿å¤±è´¥ï¼Œä¸å¦‚è®©ä¸€ä¸ªæ–­å¼€é‡æ–°åŠ å…¥ã€‚

### Q4: å…¨è¿æ¥æ‹“æ‰‘æ˜¯å¦ä¼šæˆä¸ºç“¶é¢ˆï¼Ÿ

**A**: æ˜¯çš„ï¼Œè§ 3.1 èŠ‚çš„è®¨è®ºã€‚å»ºè®®ï¼š
- < 10 ä¸ª Edgeï¼šå…¨è¿æ¥
- 10-50 ä¸ª Edgeï¼šæ··åˆæ–¹æ¡ˆï¼ˆåŠ¨æ€è·¯ç”±ï¼‰
- > 50 ä¸ª Edgeï¼šHub ä¸­è½¬

### Q5: æ¶ˆæ¯ç¼“å­˜ 1000 æ¡æ˜¯å¦è¶³å¤Ÿï¼Ÿ

**A**: å–å†³äºæ¶ˆæ¯é€Ÿç‡ï¼š
- ä½é¢‘æ§åˆ¶æ¶ˆæ¯ï¼ˆ< 10 msg/sï¼‰ï¼šå¯ç¼“å­˜ 100 ç§’
- é«˜é¢‘åŒæ­¥æ¶ˆæ¯ï¼ˆ100 msg/sï¼‰ï¼šåªèƒ½ç¼“å­˜ 10 ç§’

å¦‚æœä¸å¤Ÿï¼Œå¯ä»¥ï¼š
- å¢åŠ ç¼“å­˜å¤§å°ï¼ˆä½†å ç”¨æ›´å¤šå†…å­˜ï¼‰
- æŒ‰æ¶ˆæ¯ç±»å‹ä¼˜å…ˆçº§ç¼“å­˜ï¼ˆä¿ç•™å…³é”®æ¶ˆæ¯ï¼‰
- ç¼©çŸ­é‡è¿è¶…æ—¶ï¼ˆå‡å°‘ç¼“å­˜éœ€æ±‚ï¼‰

### Q6: UDP è¯­éŸ³åŒ…æ˜¯å¦éœ€è¦åŠ å¯†ï¼Ÿ

**A**: å»ºè®®åŠ å¯†ï¼Œä½†åœ¨é›†ç¾¤å†…é€šä¿¡å¯é€‰ï¼š
- **å†…ç½‘ç¯å¢ƒ**ï¼šå¯ä»¥ä¸åŠ å¯†ï¼Œé™ä½å¼€é”€
- **è·¨å…¬ç½‘**ï¼šå¿…é¡»åŠ å¯†ï¼Œä½¿ç”¨ AES-OCB2 æˆ– DTLS
- **æ··åˆç¯å¢ƒ**ï¼šHub-Edge åŠ å¯†ï¼ŒEdge-Edgeï¼ˆå†…ç½‘ï¼‰ä¸åŠ å¯†

å½“å‰è®¾è®¡æœªåŒ…å«åŠ å¯†ï¼Œå¯åç»­æ·»åŠ ã€‚

### Q7: å¦‚ä½•æµ‹è¯•æ•…éšœæ¢å¤ï¼Ÿ

**A**: æ•…éšœæ³¨å…¥æµ‹è¯•ï¼š
```bash
# æ¨¡æ‹Ÿ Hub æ–­å¼€
npm run test:failover -- --scenario=hub-disconnect

# æ¨¡æ‹Ÿ Peer æ–­å¼€
npm run test:failover -- --scenario=peer-disconnect

# æ¨¡æ‹Ÿç½‘ç»œåˆ†åŒº
npm run test:failover -- --scenario=network-partition

# æ¨¡æ‹Ÿé«˜å»¶è¿Ÿ
npm run test:failover -- --scenario=high-latency --latency=500ms
```

---

## åã€ä¸‹ä¸€æ­¥å»ºè®®

### 10.1 ç«‹å³å®æ–½

1. **ç§»é™¤ Protobuf + gRPC**
   - åˆ é™¤ç›¸å…³ä»£ç å’Œä¾èµ–
   - æ¸…ç†ç”Ÿæˆçš„æ–‡ä»¶

2. **å®ç° RPC Channel**
   - ä½œä¸ºå…¶ä»–æ¨¡å—çš„åŸºç¡€
   - ä¼˜å…ˆå®ç°å’Œæµ‹è¯•

3. **å®ç°æ§åˆ¶ä¿¡é“**
   - Hub æœåŠ¡ç«¯
   - Edge å®¢æˆ·ç«¯
   - åŸºæœ¬çš„ RPC æ–¹æ³•

### 10.2 åç»­ä¼˜åŒ–

1. **æ€§èƒ½ä¼˜åŒ–**
   - è¿æ¥æ± å¤ç”¨
   - æ¶ˆæ¯æ‰¹å¤„ç†
   - é›¶æ‹·è´ä¼ è¾“

2. **å®‰å…¨åŠ å›º**
   - TLS åŠ å¯†
   - èº«ä»½è®¤è¯
   - é˜²é‡æ”¾æ”»å‡»

3. **å¯è§‚æµ‹æ€§**
   - Prometheus æŒ‡æ ‡å¯¼å‡º
   - åˆ†å¸ƒå¼è¿½è¸ª
   - å‘Šè­¦è§„åˆ™

### 10.3 é•¿æœŸè§„åˆ’

1. **åŠ¨æ€è·¯ç”±**
   - æ›¿ä»£å…¨è¿æ¥æ‹“æ‰‘
   - æ”¯æŒæ›´å¤§è§„æ¨¡é›†ç¾¤

2. **è¯­éŸ³åŠ å¯†**
   - ç«¯åˆ°ç«¯åŠ å¯†é€‰é¡¹
   - æ€§èƒ½å½±å“è¯„ä¼°

3. **å¤šè¯­è¨€æ”¯æŒ**
   - è€ƒè™‘ Go/Rust å®ç°
   - Protocol Buffer å¯èƒ½å¤æ´»

---

## æ€»ç»“

æœ¬æ–‡æ¡£å®šä¹‰äº† ShitSpeak é›†ç¾¤é€šä¿¡çš„å®Œæ•´æ¶æ„ï¼š

### æ ¸å¿ƒå†³ç­–
- âœ… **æ§åˆ¶ä¿¡é“**ï¼šMessagePack + WebSocket + è‡ªå®šä¹‰ RPC
- âœ… **è¯­éŸ³ä¿¡é“**ï¼šè‡ªå®šä¹‰åè®® + UDPï¼ˆå¯é™çº§ TCPï¼‰
- âœ… **åŠ å…¥æµç¨‹**ï¼šä¸²è¡ŒåŒ–ï¼Œ60 ç§’è¶…æ—¶
- âœ… **å¿ƒè·³æœºåˆ¶**ï¼š1 ç§’/æ¬¡ï¼Œ3 ç§’è¶…æ—¶
- âœ… **é‡è¿ç­–ç•¥**ï¼šHub 10 ç§’ï¼ŒPeer 3 ç§’
- âœ… **æ•…éšœå¤„ç†**ï¼šå®Œå…¨æ–­å¼€ + é‡æ–°åŠ å…¥

### ä¼˜ç‚¹
- âœ… ç®€å•ç›´è§‚ï¼Œæ˜“äºå®ç°å’Œè°ƒè¯•
- âœ… æ€§èƒ½ä¼˜ç§€ï¼Œå»¶è¿Ÿä½ï¼Œå¼€é”€å°
- âœ… å¯é æ€§é«˜ï¼Œæ•…éšœè‡ªåŠ¨æ¢å¤
- âœ… å¯æ‰©å±•ï¼Œæ”¯æŒ 10-50 ä¸ª Edge

### éœ€è¦æ³¨æ„
- âš ï¸ å…¨è¿æ¥æ‹“æ‰‘ä¸é€‚åˆå¤§è§„æ¨¡é›†ç¾¤ï¼ˆ> 50 Edgeï¼‰
- âš ï¸ æ¶ˆæ¯ç¼“å­˜å¯èƒ½å ç”¨å†…å­˜
- âš ï¸ UDP è¯­éŸ³åŒ…æ— åŠ å¯†ï¼ˆå†…ç½‘ç¯å¢ƒå¯æ¥å—ï¼‰

### å®æ–½å»ºè®®
1. åˆ†é˜¶æ®µå®æ–½ï¼Œå…ˆå®ç°åŸºç¡€é€šä¿¡
2. å……åˆ†æµ‹è¯•æ•…éšœæ¢å¤é€»è¾‘
3. ç›‘æ§é›†ç¾¤å¥åº·çŠ¶å†µ
4. æ ¹æ®å®é™…è´Ÿè½½è°ƒæ•´å‚æ•°
